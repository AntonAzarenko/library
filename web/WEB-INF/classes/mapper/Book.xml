<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="library.dao.BookDao">

    <resultMap type="Book" id="bookmap">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="description" property="description"/>
        <association property="publisher" javaType="Publisher">
            <id property="id" column="publisher_id"/>
        </association>
        <collection property="author" ofType="author" javaType="ArrayList">
            <id property="id" column="author_id"/>
        </collection>
    </resultMap>

    <select id="find" resultMap="bookmap" parameterType="string">
		SELECT
		b.id,
		b.title,
		b.description,
		b.publisher_id,
		a.id AS author_id
		from authors_books as ab
		inner join books as b on ab.book_id = b.id
		inner join authors as a on ab.author_id=a.id
		WHERE title = #{title}
	</select>

    <select id="findByAuthorId" parameterType="long"
            resultMap="bookmap">
		SELECT
		b.id,
		b.title,
		b.description,
		b.publisher_id,
		a.id AS author_id
		from authors_books as ab
		inner join books as b on ab.book_id = b.id
		inner join authors as a on ab.author_id=a.id
		WHERE
		a.id = #{id}
	</select>

    <select id="findBooksByPublisher" parameterType="string"
            resultMap="bookmap">
		SELECT
		b.id,
		b.title,
		b.description,
		b.publisher_id,
		a.id AS author_id
		from authors_books as ab
		inner join books as b on ab.book_id = b.id
		inner join authors as a on ab.author_id=a.id
		inner join publishers p on b.publisher_id = p.id
		where p.name like #{name}
	</select>

    <select id="findAll" resultMap="bookmap">
		SELECT
		b.id,
		b.title,
		b.description,
		b.publisher_id,
		a.id AS author_id
		from authors_books as ab
		inner join books as b on ab.book_id = b.id
		inner join authors as a on ab.author_id=a.id
	</select>


    <insert id="create" parameterType="Book" useGeneratedKeys="true"
            keyProperty="id">
		INSERT INTO books (title, description, publisher_id) VALUES
		(#{title}, #{description}, #{publisher.id})
	</insert>

    <insert id="createAuthors_books">
        insert into authors_books (author_id, book_id) values
        <foreach collection="author" item="auth" index="index" separator=",">
            ( #{auth.id}, #{id} )
        </foreach>
    </insert>

    <select id="read" resultMap="bookmap" parameterType="long">
		SELECT
		b.id,
		b.title,
		b.description,
		b.publisher_id,
		a.id AS author_id
		from authors_books as ab
		inner join books as b on ab.book_id = b.id
		inner join authors as a on ab.author_id=a.id
		WHERE b.id = #{id}
	</select>

    <update id="update" parameterType="Book">
        UPDATE books SET title = #{title}, description=#{description}, publisher_id =
        #{publisher.id} WHERE id = #{id}
    </update>

    <update id="updateAuthors_books">
        <foreach collection="author" item="auth" index="index" separator=";">
            update authors_books SET author_id = #{auth.id} where book_id=#{id}
        </foreach>
    </update>

    <delete id="delete" parameterType="long">
		DELETE FROM books WHERE id =
		#{id}
	</delete>
</mapper>